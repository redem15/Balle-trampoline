
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Balle Trampoline ‚Äì Pelote Jaune & Nuages Chat</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#87CEEB; }
canvas { display:block; }
#score { position:absolute; top:10px; left:10px; font-size:24px; color:#333; font-family:sans-serif; z-index:5; }
#menu, #gameOver, #shop {
  position:absolute; top:0; left:0; width:100%; height:100%;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  color:white; font-family:sans-serif; z-index:10; text-align:center;
}
#menu, #gameOver { background:rgba(0,0,0,0.6); }
#shop { background:rgba(0,0,0,0.85); display:none; }
#gameTitle { font-size:60px; margin-bottom:20px; }
#bestScoreMenu { font-size:28px; margin-bottom:15px; }
#instructions { font-size:24px; margin-bottom:30px; }
button { font-size:28px; padding:15px 30px; cursor:pointer; border:none; border-radius:10px; background:#33aa33; color:white; font-weight:bold; margin:5px; }
button:hover { background:#2d992d; }
.coin-count { font-size:24px; margin-bottom:20px; }
.buy-ball { display:block; margin:5px; }
.buy-ball.selected {
    border: 4px solid #00f; /* contour bleu */
    box-shadow: 0 0 10px #00f;
}
</style>
</head>
<body>
<div id="score">Score: 0 | Meilleur: 0 | Pi√®ces: 0</div>

<div id="menu">
  <h1 id="gameTitle">Balle Trampoline</h1>
  <p id="bestScoreMenu">Meilleur score : 0</p>
  <p id="instructions">D√©place le trampoline avec la souris pour faire rebondir la balle !</p>
  <button id="startBtn">Jouer</button>
</div>

<div id="gameOver" style="display:none;">
  <h2>Game Over</h2>
  <p id="finalScore"></p>
  <button id="restartBtn">Rejouer</button>
  <button id="shopBtn">Boutique</button>
</div>

<div id="shop">
  <h2>Boutique</h2>
  <p class="coin-count">Pi√®ces : <span id="shopCoins">0</span></p>
  <button class="buy-ball" data-ball="yellow">Balle Jaune</button>
  <button class="buy-ball" data-ball="emoji">Balle üòÑ (10 pi√®ces)</button>
  <button class="buy-ball" data-ball="crying">Balle üò¢ (100 pi√®ces)</button>
  <button class="buy-ball" data-ball="love">Balle üòç (100 pi√®ces)</button>
  <button class="buy-ball" data-ball="sleep">Balle üò¥ (100 pi√®ces)</button>
  <button class="buy-ball" data-ball="cool">Balle üòé (150 pi√®ces)</button>
  <button class="buy-ball" data-ball="money">Balle üíµ (500 pi√®ces)</button>
  <button id="backBtn">Retour</button>
</div>

<canvas id="gameCanvas"></canvas>
<audio id="bgMusic" src="background.mp3" loop autoplay></audio>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreDiv = document.getElementById('score');
const menu = document.getElementById('menu');
const gameOverScreen = document.getElementById('gameOver');
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
const finalScore = document.getElementById('finalScore');
const bestScoreMenu = document.getElementById('bestScoreMenu');
const shopScreen = document.getElementById('shop');
const shopCoinsSpan = document.getElementById('shopCoins');
const backBtn = document.getElementById('backBtn');
const shopBtn = document.getElementById('shopBtn');
const bgMusic = document.getElementById('bgMusic');

let gameStarted = false;
function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let ball = { x:0, y:0, radius:30, dx:0, dy:2 };
let trampoline = { width:300, height:20, x:canvas.width/2-150, y:canvas.height-100 };
let score = 0;

let bestScore = localStorage.getItem('bestScore') ? parseInt(localStorage.getItem('bestScore')) : 0;
bestScoreMenu.innerText = `Meilleur score : ${bestScore}`;
let totalCoinsCollected = localStorage.getItem('totalCoinsCollected') ? parseInt(localStorage.getItem('totalCoinsCollected')) : 0;

let currentBall = localStorage.getItem('currentBall') || 'yellow';
let ownedBalls = localStorage.getItem('ownedBalls') ? JSON.parse(localStorage.getItem('ownedBalls')) : ['yellow'];

let explosionActive = false;
let explosionStartTime = 0;

let coins = [];
const maxCoins = 20;
let lastCoinSpawn = 0;
const coinSpawnInterval = 5000;

let clouds = [];
for(let i=0;i<8;i++){
    clouds.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height/2, size:30+Math.random()*50, speed:0.2+Math.random()*0.5 });
}

let decorations = [];
function initDecorations(){
    decorations = [];
    for(let i=0;i<30;i++){
        decorations.push({ type: 'flower', x: Math.random()*canvas.width, y: canvas.height - 50 + Math.random()*20, radius: 2 + Math.random()*2, color: `hsl(${Math.random()*60 + 300}, 80%, 60%)` });
    }
    for(let i=0;i<20;i++){
        decorations.push({ type: 'stone', x: Math.random()*canvas.width, y: canvas.height - 50 + Math.random()*20, w: 3 + Math.random()*3, h: 2 + Math.random()*2, color: `hsl(0,0%,${30+Math.random()*20}%)` });
    }
}

let trail = []; // positions de la tra√Æn√©e
const maxTrailLength = 20;

function resetBall(){
    ball.x = ball.radius + Math.random()*(canvas.width-2*ball.radius);
    ball.y = ball.radius + Math.random()*(canvas.height/2-ball.radius);
    ball.dx = (Math.random()-0.5)*4; // vitesse horizontale al√©atoire
    ball.dy = 2;
}

function drawSky(){
    let topColor = '#87CEEB'; 
    let bottomColor = '#4682B4';
    if(score >= 125){ topColor = '#5A9BD5'; bottomColor = '#2F5782'; }
    let grad = ctx.createLinearGradient(0,0,0,canvas.height);
    grad.addColorStop(0, topColor);
    grad.addColorStop(1, bottomColor);
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    clouds.forEach(c=>{
        ctx.fillStyle='rgba(255,255,255,0.45)';
        ctx.shadowColor='rgba(255,255,255,0.6)';
        ctx.shadowBlur=20;
        ctx.beginPath(); ctx.arc(c.x,c.y,c.size,0,Math.PI*2); ctx.fill();
        ctx.shadowBlur=0;
        c.x += c.speed; if(c.x-c.size>canvas.width) c.x=-c.size;
    });
}

function drawGrass(){
    let grassHeight = 50;
    for(let i=0; i<canvas.width; i+=2){
        let h = grassHeight + Math.random()*10;
        ctx.beginPath();
        ctx.moveTo(i, canvas.height);
        ctx.lineTo(i+1, canvas.height - h);
        ctx.strokeStyle = `hsl(${100 + Math.random()*30}, 70%, 40%)`;
        ctx.lineWidth = 2;
        ctx.stroke();
    }
}

function drawDecorations(){
    decorations.forEach(d=>{
        if(d.type === 'flower'){
            ctx.beginPath();
            ctx.arc(d.x, d.y, d.radius, 0, Math.PI*2);
            ctx.fillStyle = d.color;
            ctx.fill();
        } else if(d.type === 'stone'){
            ctx.fillStyle = d.color;
            ctx.fillRect(d.x, d.y, d.w, d.h);
        }
    });
}

function drawBall(){
    ctx.font = `${ball.radius*2}px sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    switch(currentBall){
        case 'emoji': ctx.fillText("üòÑ", ball.x, ball.y); break;
        case 'crying': ctx.fillText("üò¢", ball.x, ball.y); break;
        case 'love': ctx.fillText("üòç", ball.x, ball.y); break;
        case 'sleep': ctx.fillText("üò¥", ball.x, ball.y); break;
        case 'cool': ctx.fillText("üòé", ball.x, ball.y); break;
        case 'money': ctx.fillText("üíµ", ball.x, ball.y); break;
        case 'yellow':
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
            ctx.fillStyle = "#FFD700";
            ctx.fill();
            ctx.closePath();
            break;
    }
}

function drawTrampoline(){
    let bounceEffect = 0;
    if(ball.y + ball.radius > trampoline.y - 10 && ball.x > trampoline.x && ball.x < trampoline.x + trampoline.width){
        let hitPos = (ball.x - (trampoline.x+trampoline.width/2))/(trampoline.width/2);
        bounceEffect = -20 + Math.abs(hitPos)*10;
    }
    ctx.beginPath();
    ctx.moveTo(trampoline.x, trampoline.y + trampoline.height);
    ctx.quadraticCurveTo(trampoline.x+trampoline.width/2, trampoline.y+bounceEffect, trampoline.x+trampoline.width, trampoline.y+trampoline.height);
    let grad = ctx.createLinearGradient(trampoline.x,trampoline.y,trampoline.x,trampoline.y+trampoline.height);
    grad.addColorStop(0, "#66ccff"); grad.addColorStop(1, "#3399ff");
    ctx.fillStyle = grad;
    ctx.fill(); ctx.closePath();

    ctx.lineWidth=6; ctx.strokeStyle="#555";
    ctx.beginPath();
    ctx.moveTo(trampoline.x,trampoline.y+trampoline.height);
    ctx.quadraticCurveTo(trampoline.x+trampoline.width/2,trampoline.y+bounceEffect,trampoline.x+trampoline.width,trampoline.y+trampoline.height);
    ctx.stroke(); ctx.closePath();

    let legHeight=20, legSpacing=30;
    for(let i=0;i<=trampoline.width;i+=legSpacing){
        let x = trampoline.x + i;
        ctx.beginPath(); ctx.moveTo(x,trampoline.y+trampoline.height);
        ctx.lineTo(x,trampoline.y+trampoline.height+legHeight);
        ctx.lineWidth=4; ctx.strokeStyle="#555"; ctx.stroke(); ctx.closePath();
    }
}

function updateTrampolineLength(){
    if(score > 0 && score % 10 === 0 && score < 50){
        trampoline.width /= 1.1;
        if(trampoline.x + trampoline.width > canvas.width) trampoline.x = canvas.width - trampoline.width;
    }
}

let isDragging=false;
canvas.addEventListener('mousedown',()=>{isDragging=true;});
canvas.addEventListener('mouseup',()=>{isDragging=false;});
canvas.addEventListener('mouseleave',()=>{isDragging=false;});
canvas.addEventListener('mousemove',e=>{
    if(isDragging){
        const rect=canvas.getBoundingClientRect();
        trampoline.x=e.clientX-rect.left-trampoline.width/2;
        if(trampoline.x<0) trampoline.x=0;
        if(trampoline.x+trampoline.width>canvas.width) trampoline.x = canvas.width-trampoline.width;
    }
});

// -------------------- COINS ---------------------
function spawnCoin() {
    if(coins.length < maxCoins){
        const x = canvas.width/4 + Math.random()*canvas.width/2;
        const y = canvas.height/2 + Math.random()*(trampoline.y - canvas.height/2 - 30); 
        coins.push({x, y, radius:10});
    }
}
function drawCoins(){
    coins.forEach(coin=>{
        ctx.beginPath();
        ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI*2);
        ctx.fillStyle = "gold";
        ctx.fill();
        ctx.strokeStyle = "orange";
        ctx.lineWidth = 2;
        ctx.stroke();
    });
}

// -------------------- SHOP ---------------------
function updateShopButtons() {
    document.querySelectorAll('.buy-ball').forEach(btn => {
        const ballId = btn.getAttribute('data-ball');
        if (ownedBalls.includes(ballId)) {
            switch(ballId){
                case 'emoji': btn.innerText = "Balle üòÑ (Poss√©d√©)"; break;
                case 'crying': btn.innerText = "Balle üò¢ (Poss√©d√©)"; break;
                case 'love': btn.innerText = "Balle üòç (Poss√©d√©)"; break;
                case 'sleep': btn.innerText = "Balle üò¥ (Poss√©d√©)"; break;
                case 'cool': btn.innerText = "Balle üòé (Poss√©d√©)"; break;
                case 'money': btn.innerText = "Balle üíµ (Poss√©d√©)"; break;
                case 'yellow': btn.innerText = "Balle Jaune"; break;
            }
        } else {
            switch(ballId){
                case 'emoji': btn.innerText = "Balle üòÑ (10 pi√®ces)"; break;
                case 'crying': btn.innerText = "Balle üò¢ (100 pi√®ces)"; break;
                case 'love': btn.innerText = "Balle üòç (100 pi√®ces)"; break;
                case 'sleep': btn.innerText = "Balle üò¥ (100 pi√®ces)"; break;
                case 'cool': btn.innerText = "Balle üòé (150 pi√®ces)"; break;
                case 'money': btn.innerText = "Balle üíµ (500 pi√®ces)"; break;
            }
        }
        if(ballId === currentBall){
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
}
updateShopButtons();

shopBtn.onclick = () => {
    shopCoinsSpan.innerText = totalCoinsCollected;
    shopScreen.style.display='flex';
    gameOverScreen.style.display='none';
    updateShopButtons();
};

backBtn.onclick = () => {
    shopScreen.style.display='none';
    gameOverScreen.style.display='flex';
};

document.querySelectorAll('.buy-ball').forEach(btn=>{
  btn.onclick = ()=>{
    const ballId = btn.getAttribute('data-ball');
    let price = 0;
    switch(ballId){
        case 'emoji': price = 10; break;
        case 'crying': price = 100; break;
        case 'love': price = 100; break;
        case 'sleep': price = 100; break;
        case 'cool': price = 150; break;
        case 'money': price = 500; break;
        case 'yellow': price = 0; break;
    }
    if(!ownedBalls.includes(ballId)){
        if(totalCoinsCollected >= price){
            totalCoinsCollected -= price;
            ownedBalls.push(ballId);
            currentBall = ballId;
            localStorage.setItem('ownedBalls', JSON.stringify(ownedBalls));
            localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
            localStorage.setItem('currentBall', currentBall);
            shopCoinsSpan.innerText = totalCoinsCollected;
            alert(`Balle ${btn.innerText.split(' ')[1]} achet√©e et s√©lectionn√©e !`);
        } else { alert("Pas assez de pi√®ces !"); return; }
    } else {
        currentBall = ballId;
        localStorage.setItem('currentBall', currentBall);
    }
    updateShopButtons();
  }
});

// -------------------- START / RESTART ---------------------
initDecorations();
startBtn.onclick=()=>{
    menu.style.display='none';
    gameStarted=true;
    resetBall();
    bgMusic.play();
    update();
}

restartBtn.onclick=()=>{
    gameOverScreen.style.display='none';
    gameStarted=true;
    resetBall();
    score=0;
    trampoline.width=300; trampoline.x=canvas.width/2-trampoline.width/2;
    bgMusic.play();
    update();
}

// -------------------- GAME LOOP ---------------------
function update(){
    if(!gameStarted) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawSky(); drawGrass(); drawDecorations(); drawTrampoline(); 

    // Ajouter la position actuelle √† la tra√Æn√©e
    trail.push({x: ball.x, y: ball.y});
    if(trail.length > maxTrailLength) trail.shift();

    // Dessiner la tra√Æn√©e
    if(score >= 15){
        for(let i=0;i<trail.length;i++){
            let t = trail[i];
            let alpha = i / trail.length;
            let color = 'yellow';
            if(score >= 35 && score < 60) color = 'red';
            else if(score >= 60 && score < 90) color = 'blue';
            else if(score >= 90 && score < 125) color = 'green';

            ctx.beginPath();
            ctx.arc(t.x, t.y, ball.radius*0.8, 0, Math.PI*2);

            if(score >= 125){
                let grad = ctx.createRadialGradient(t.x, t.y, 0, t.x, t.y, ball.radius*0.8);
                grad.addColorStop(0, 'yellow');
                grad.addColorStop(1, 'red');
                ctx.fillStyle = grad;
            } else {
                ctx.fillStyle = color;
            }

            ctx.globalAlpha = 0.5 * (1-alpha);
            ctx.fill();
            ctx.closePath();
        }
        ctx.globalAlpha = 1;
    }

    drawBall();

    coins = coins.filter(coin=>{
        const dx = ball.x - coin.x;
        const dy = ball.y - coin.y;
        const distance = Math.sqrt(dx*dx + dy*dy);
        if(distance < ball.radius + coin.radius){
            totalCoinsCollected++;
            localStorage.setItem('totalCoinsCollected', totalCoinsCollected);
            return false;
        }
        return true;
    });
    drawCoins();

    if(Date.now() - lastCoinSpawn > coinSpawnInterval){
        spawnCoin();
        lastCoinSpawn = Date.now();
    }

    let gravity = 0.1 + score*0.002;
    if(score >= 10) gravity *= 2;  
    if(score >= 75) gravity *= 2;  

    ball.dy += gravity; ball.x += ball.dx; ball.y += ball.dy;

    if(ball.x-ball.radius<=0){ ball.x=ball.radius; ball.dx=-ball.dx; }
    if(ball.x+ball.radius>=canvas.width){ ball.x=canvas.width-ball.radius; ball.dx=-ball.dx; }

    if(ball.y+ball.radius>=trampoline.y){
        if(ball.x>trampoline.x && ball.x<trampoline.x+trampoline.width){
            ball.y=trampoline.y-ball.radius;
            let targetHeight = canvas.height/2;
            let heightDiff = Math.max(0,trampoline.y-targetHeight);
            ball.dy = -Math.sqrt(2*gravity*heightDiff);
            let hitPos = (ball.x-(trampoline.x+trampoline.width/2))/(trampoline.width/2);
            ball.dx = hitPos*5 + (Math.random()-0.5)*10;
            let accel = 1 + Math.min(score/2000,0.05); ball.dx*=accel; ball.dy*=accel;
            let maxDx=15+Math.floor(score/100); if(ball.dx>maxDx) ball.dx=maxDx; if(ball.dx<-maxDx) ball.dx=-maxDx;
            score++;
            if(score === 50){ explosionActive = true; explosionStartTime = Date.now(); }
            updateTrampolineLength();
        } else {
            if(score>bestScore){ bestScore=score; localStorage.setItem('bestScore', bestScore);}
            finalScore.innerText=`Score: ${score} | Meilleur: ${bestScore} | Pi√®ces: ${totalCoinsCollected}`;
            gameOverScreen.style.display='flex';
            gameStarted=false;
            score=0;
            trampoline.width=300; trampoline.x=canvas.width/2-trampoline.width/2;
        }
    }

    if(explosionActive){
        for(let i = 0; i < 50; i++){
            ctx.beginPath();
            let x = Math.random() * canvas.width;
            let y = Math.random() * canvas.height;
            let radius = 5 + Math.random() * 20;
            let r = Math.floor(Math.random() * 255);
            let g = Math.floor(Math.random() * 255);
            let b = Math.floor(Math.random() * 255);
            ctx.fillStyle = `rgba(${r},${g},${b},0.7)`;
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.fillStyle = "white";
        ctx.font = "50px sans-serif";
        ctx.fillText("50 POINTS !", canvas.width/2 - 120, canvas.height/2);
        if(Date.now() - explosionStartTime > 2000){ explosionActive = false; }
    }

    scoreDiv.innerText=`Score: ${score} | Meilleur: ${bestScore} | Pi√®ces: ${totalCoinsCollected}`;
    requestAnimationFrame(update);
}
</script>
</body>
</html>
